version: "3.3"
services:
  django:
    secrets:
      - secret_key
      - ksso_client_id
      - ksso_state_key
      - ksso_secret_key
    build:
      target: prod
    command: sh -c "
      python manage.py migrate &&
      python manage.py collectstatic --noinput &&
      gunicorn --workers=10 --pythonpath=/app -b 0.0.0.0:8000 web.wsgi"
    volumes:
      - ./web/media:/app/media
      - ./web/collectstatic:/app/collectstatic
    environment:
      - PRODUCTION=true
      - DJANGO_DEBUG=0
      - SECRET_DJANGO_SECRET_KEY=/run/secrets/secret_key
      - KSSO_LOGIN_URL=https://iam2.kaist.ac.kr/api/sso/commonLogin
      - KSSO_LOGOUT_URL=https://iam2.kaist.ac.kr/api/sso/logout
      - SECRET_KSSO_CLIENT_ID=/run/secrets/ksso_client_id
      - SECRET_KSSO_STATE_KEY=/run/secrets/ksso_state_key
      - SECRET_KSSO_SECRET_KEY=/run/secrets/ksso_secret_key
      - DJANGO_ALLOWED_HOSTS=localhost kisa.kaist.ac.kr
  nginx:
    build:
      target: prod
    ports:
      - 443:8081
      - 80:8080
    volumes:
      - ./install/nginx/ssl_config/wwwroot:/wwwroot
      - ./install/nginx/ssl_config/letsencrypt:/etc/letsencrypt
    environment:
      - NGINX_HOST=kisa.kaist.ac.kr
      - NGINX_SECURE_PORT=8081
secrets:
  secret_key:
    file: ./secrets/secret-key.txt
  ksso_client_id:
    file: ./secrets/ksso-client-id.txt
  ksso_state_key:
    file: ./secrets/ksso-state-key.txt
  ksso_secret_key:
    file: ./secrets/ksso-secret-key.txt
