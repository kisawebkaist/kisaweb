version: '3.3'
services:
  db:
    image: postgres:14-bookworm
    secrets:
      - db_name
      - db_user
      - db_password
    environment:
      - POSTGRES_DB_FILE=/run/secrets/db_name
      - POSTGRES_USER_FILE=/run/secrets/db_user
      - POSTGRES_PASSWORD_FILE=/run/secrets/db_password
    volumes:
      - ./data/db:/var/lib/postgresql/data
  backend:
    build:
      dockerfile: dockerfile.backend
      context: ./backend
      target: prod
    command: sh -c "python manage.py migrate && gunicorn web.wsgi -b 0.0.0.0:8000 --workers=10"
    ports:
      - 10002:8000
    depends_on:
      - db
    secrets:
      - db_name
      - db_user
      - db_password
      - secret_key
      - public_key
      - private_key
      - sso_secret
    deploy:
      restart_policy:
        condition: on-failure
        delay: 5s
        window: 10s
    environment:
      - PRODUCTION=true
      - SECRET_KEY=/run/secrets/secret_key
      - DB_USER=/run/secrets/db_user
      - DB_NAME=/run/secrets/db_name
      - DB_PASSWORD=/run/secrets/db_password
      - DB_PORT=5432
      - DB_HOST=db
      - PUBLIC_KEY=/run/secrets/public_key
      - PRIVATE_KEY=/run/secrets/private_key
      - KSSO_SECRET_KEY=/run/secrets/sso_secret
      - KSSO_CLIENT_ID=KISA
      - KSSO_LOGIN_URL=https://iam2.kaist.ac.kr
      - KSSO_LOGOUT_URL=https://iam2.kaist.ac.kr
      - ALLOWED_HOSTS=kisa.kaist.ac.kr
      - CORS_ALLOWED_ORIGINS=http://localhost:3000,http://localhost:81,https://kisa.kaist.ac.kr
  frontend:
    build:
      dockerfile: dockerfile.frontend
      context: ./frontend
      target: prod
      args:
        - REACT_APP_API_PUBLIC_KEY=/run/secrets/public_key
        - REACT_APP_API_ENDPOINT=https://kisa.kaist.ac.kr/dev-backend/api/
    command: serve -s build -l tcp://0.0.0.0:3000
    ports:
      - 10001:3000
    depends_on:
      - backend
secrets:
  db_name:
    file: ../secrets/db_name.txt
  db_user:
    file: ../secrets/db_user.txt
  db_password:
    file: ../secrets/db_password.txt
  secret_key:
    file: ../secrets/secret_key.txt
  public_key:
    file: ../secrets/public_key.txt
  private_key:
    file: ../secrets/private_key.txt
  sso_secret:
    file: ../secrets/sso_secret.txt
